<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Genre Manager Configuration</title>
</head>
<body>
    <div data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox">
        <div data-role="content">
            <div class="content-primary">
                <form id="GenreManagerConfigForm">
                    <div class="sectionTitleContainer">
                        <h2 class="sectionTitle">Genre Manager Configuration</h2>
                        <p>Select genres to display on your Jellyfin home page.</p>
                    </div>

                    <!-- Important notice -->
                    <div class="paperList" style="background: #2c2c2c; padding: 1em; margin-bottom: 1.5em; border-radius: 4px;">
                        <div style="display: flex; align-items: center;">
                            <i class="md-icon" style="font-size: 2em; margin-right: 0.5em; color: #00a4dc;">info</i>
                            <div>
                                <h3 style="margin: 0;">Required Plugin</h3>
                                <p style="margin: 0.5em 0 0 0;">
                                    This plugin requires <strong>Home Screen Sections</strong> plugin to be installed and enabled.<br/>
                                    After saving changes, <strong>restart Jellyfin</strong> and enable the genre sections in Home Screen Sections settings.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- General Options -->
                    <div class="inputContainer">
                        <label for="numItems">Items per genre section:</label>
                        <input is="emby-input" type="number" id="numItems" min="5" max="50" />
                    </div>

                    <label class="checkboxContainer">
                        <input is="emby-checkbox" type="checkbox" id="chkMoviesOnly" />
                        <span>Show only movies (exclude TV series)</span>
                    </label>

                    <br/>

                    <!-- Genre Selection -->
                    <div class="verticalSection">
                        <h3>Genres to display on home page</h3>
                        <p>Check the genres you want to appear as sections:</p>
                        <div id="genreCheckboxes"></div>
                    </div>

                    <br/>
                    <button is="emby-button" type="submit" class="raised button-submit block">
                        <span>Save</span>
                    </button>
                </form>
            </div>
        </div>

        <script type="text/javascript">
            var GenreManagerConfig = {
                pluginId: "014df46b-ffdc-414f-b841-e7fb5546b8e5"
            };

            // Available genres (static list matching Jellyfin native genres)
            var availableGenres = [
                "Action", "Adventure", "Animation", "Comedy", "Crime",
                "Documentary", "Drama", "Family", "Fantasy", "Horror",
                "Mystery", "Romance", "Science Fiction", "Thriller", "Western",
                "Biography", "History", "Music", "War", "Sport"
            ];

            // Load configuration on page load
            function loadConfiguration() {
                Dashboard.showLoadingMsg();

                ApiClient.getPluginConfiguration(GenreManagerConfig.pluginId)
                    .then(function (config) {
                        document.querySelector('#numItems').value = config.ItemsPerSection || 20;
                        document.querySelector('#chkMoviesOnly').checked = config.ShowOnlyMovies || false;

                        buildGenreCheckboxes(config.SelectedGenres || []);

                        Dashboard.hideLoadingMsg();
                    });
            }

            // Try multiple events to ensure loading
            var pageElement = document.querySelector('#GenreManagerConfigForm').parentElement;
            pageElement.addEventListener('pageshow', loadConfiguration);

            // Fallback if pageshow doesn't trigger
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', loadConfiguration);
            } else {
                loadConfiguration();
            }

            // Save configuration
            document.querySelector('#GenreManagerConfigForm')
                .addEventListener('submit', function(e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(GenreManagerConfig.pluginId)
                        .then(function (config) {
                            config.ItemsPerSection = parseInt(document.querySelector('#numItems').value);
                            config.ShowOnlyMovies = document.querySelector('#chkMoviesOnly').checked;
                            config.SelectedGenres = getSelectedGenres();

                            ApiClient.updatePluginConfiguration(GenreManagerConfig.pluginId, config)
                                .then(function (result) {
                                    Dashboard.processPluginConfigurationUpdateResult(result);
                                    Dashboard.alert('Configuration saved. Please restart Jellyfin for changes to take effect.');
                                });
                        });

                    return false;
                });

            // Build genre checkboxes
            function buildGenreCheckboxes(selectedGenres) {
                var container = document.querySelector('#genreCheckboxes');
                var html = '';

                availableGenres.forEach(function(genre) {
                    var checked = selectedGenres.indexOf(genre) !== -1 ? 'checked' : '';
                    html += '<label class="checkboxContainer">';
                    html += '<input is="emby-checkbox" type="checkbox" class="genreCheckbox" ';
                    html += 'data-genre="' + genre + '" ' + checked + ' />';
                    html += '<span>' + genre + '</span>';
                    html += '</label>';
                });

                container.innerHTML = html;
            }

            // Get selected genres
            function getSelectedGenres() {
                var selected = [];
                document.querySelectorAll('.genreCheckbox').forEach(function(cb) {
                    if (cb.checked) {
                        selected.push(cb.getAttribute('data-genre'));
                    }
                });
                return selected;
            }
        </script>
    </div>
</body>
</html>
